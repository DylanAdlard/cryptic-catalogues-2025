---
title: "cryptic_catalogue_senspec"
author: "Kerri M Malone"
date: "2024-02-15"
output: html_document
---

```{r setup, include=FALSE}


libs_load <- function(x){
  for( i in x ){
    print(paste0("Checking for library: ", i))
    if(require( i , character.only = TRUE ) ){
      print(paste0(i, " already installed. Loading now"))
    }
    #  require returns TRUE invisibly if it was able to load package
    if( ! require( i , character.only = TRUE ) ){
      print(paste0(i, " not installed. Trying CRAN for install."))
      #  If package was not able to be loaded then re-install
      install.packages( i , dependencies = TRUE )
      require( i , character.only = TRUE )
      paste0(i, " installed and loaded successfully")
    }
    if ( ! require(i, character.only=TRUE) ) {
      paste0(i," could not be installed from CRAN. Trying Bionconductor....")
      BiocManager::install(i)
      require( i , character.only = TRUE )
      paste0(i, " installed and loaded successfully")
    }
    if ( ! require(i, character.only=TRUE) ) {
      paste0(i, "could not be installed. Check manually")
    }
    #  Load package after installing
  }
}

#Load libraries
libs_load(c("data.table", "jsonlite","tidyverse"))

`%notin%` <- Negate(`%in%`)
```



```{r}
calculate_metrics = function(vpred_file, vpheno_file, WHO_cat=FALSE, drug_codes_json=FALSE) {
  vpheno = fread(vpheno_file)
  
  if (WHO_cat == TRUE){
    vpred = fread(vpred_file)
    drug_codes=fromJSON(drug_codes_json)
    drug_codes = as.list(rev(setNames(names(drug_codes), unname(drug_codes))))
    drug_codes_vec <- unlist(drug_codes)
    vpred = vpred %>% 
    mutate(drug = recode(drug, !!!drug_codes_vec)) 
  }
  
  else {
    vpred = fread(vpred_file)
  }
  

  # create merge columns
  # make sure drugs being compared are equal 
  vpred = vpred %>%
    rename("ena_run" = uniqueid) %>%
    mutate(merge = paste0(ena_run, "_", drug))
  
  vpheno = vpheno %>%
    mutate(merge = paste0(ena_run, "_", drug))
  
  
  vdat = vpheno %>%
    merge(., vpred, by = "merge") %>%
    select(-c(ena_run.y, drug.y)) %>%
    rename("drug" = drug.x) %>%
    rename("ena_run" = ena_run.x)

  calculate_metrics_per_drug <- function(df) {
    conf_matrix <- table(df$phenotype, df$prediction)
    conf_df = as.data.frame(conf_matrix) %>%
      rename("prediction" = Var2) %>%
      rename("phenotype" = Var1) %>%
      rename("count" = Freq) 
    
    tp = conf_df %>%
      filter(prediction == "pred_R" & phenotype == "pheno_R") %>%
      pull(count)
    
    # If no pred_R present, set to 0
    if (length(tp) == 0) {
      tp = 0
    }    
    
    fn = conf_df %>%
      filter(prediction == "pred_S" & phenotype == "pheno_R") %>%
      pull(count)
    
    # If no pred_S present, set to 0
    if (length(fn) == 0) {
      fn = 0
    }        
    
    tn = conf_df %>%
      filter(prediction == "pred_S" & phenotype == "pheno_S") %>%
      pull(count)
    
    # If no pred_S present, set to 0
    if (length(tn) == 0) {
      tn = 0
    }    
    
    fp = conf_df %>%
      filter(prediction == "pred_R" & phenotype == "pheno_S") %>%
      pull(count)
    
    # If no pred_R present, set to 0
    if (length(fp) == 0) {
      fp = 0
    }    
    
    U_count_R = conf_df %>%
      filter(prediction == "pred_U" & phenotype == "pheno_R") %>%
      pull(count)
      
    # If no pred_U present, set to 0
    if (length(U_count_R) == 0) {
      U_count_R = 0
    }
    
    U_count_S = conf_df %>%
      filter(prediction == "pred_U" & phenotype == "pheno_S") %>%
      pull(count)   
    
    
    # If no pred_U present, set to 0
    if (length(U_count_S) == 0) {
      U_count_S = 0
    }   
    
    total_U_count = U_count_R + U_count_S
    
    total_pheno_count_R = as.numeric(rowSums(conf_matrix)[1])
    
    total_pheno_count_S = as.numeric(rowSums(conf_matrix)[2])
    
    total_pheno_count = total_pheno_count_R + total_pheno_count_S 
    
    coverage = as.numeric((total_pheno_count - total_U_count)/total_pheno_count)
      
    sensitivity = tp / (tp + fn)
    specificity = tn / (tn + fp)
    ppv = tp / (tp + fp)
    npv = tn / (tn + fn)
    
    # Return metrics
    return(data.frame(drug = df$drug[1], sensitivity = sensitivity, specificity = specificity, ppv = ppv, npv = npv, coverage = coverage,
                      total_pheno_R = total_pheno_count_R, total_pheno_S = total_pheno_count_S, total_pred_R_pheno_R = tp, total_pred_S_pheno_S = tn, total_pred_R_pheno_S = fp, total_pred_S_pheno_R = fn, total_pred_U = total_U_count))
    }

  results_list = list()
  for (this_drug in unique(vdat$drug)){
    print(paste0("On ", this_drug))
    df = vdat %>%
      filter(drug == this_drug) %>%
      mutate(prediction = paste0("pred_", prediction)) %>%
      mutate(phenotype = paste0("pheno_", phenotype))
    
    
    required_vals_pheno <- c("pheno_S", "pheno_R", "pheno_U")
    required_vals_pred <- c("pred_S", "pred_R")
    optional_val_pred <- "pred_U"
    
    # Check if all required pheno values are present
    if (!all(required_vals_pheno %in% unique(df$phenotype))) {
      missing_phenos <- required_vals_pheno[!required_vals_pheno %in% unique(df$phenotype)]
      print(paste("Missing pred values:", paste(missing_phenos, collapse = ", ")))
    }
    
    # Check if both pred_S and pred_R are present
    if (!all(required_vals_pred %in% unique(df$prediction))) {
      missing_preds <- required_vals_pred[!required_vals_pred %in% unique(df$prediction)]
      print(paste("Missing pred values:", paste(missing_preds, collapse = ", ")))
    }
    
    # Check if pred_U is present and print a message
    if (optional_val_pred %in% unique(df$prediction)) {
      print("Optional pred value (pred_U) is present.")
    } else {
      print("Optional pred value (pred_U) is absent.")
    }
    this_res = df %>% 
      do(calculate_metrics_per_drug(.))
    results_list[[this_drug]] = this_res
  }
  
  return(bind_rows(results_list))
}
  
#ami_add = data.frame(phenotype=c("pheno_R", "pheno_S", "pheno_U"), prediction = c("pred_R", "pred_R", "pred_R"), count = c(0,0,0))
#lzd_add = data.frame(phenotype=c("pheno_R", "pheno_S", "pheno_U"), prediction = c("pred_R", "pred_R", "pred_R"), count = c(0,0,0))

```

```{r}

VPRED = "/github/cryptic-catalogue/data/validation/catomatic_202406_validation_prediction_results.csv"

WHO_2 = "/github/cryptic-catalogue/data/validation/catomatic_202406_validation_prediction_results_WHOv2.csv"

VPHENO = "/github/cryptic-catalogue/creating_training_validation_sets/validation_data_phenotypes_20240207.tsv"



validation_results = calculate_metrics(VPRED, VPHENO)


who_2_results = calculate_metrics(WHO_2, VPHENO, WHO_cat = TRUE, drug_codes_json ="/github/cryptic-catalogue/data/drug_codes.json" )

vpheno = fread(VPHENO)

pheno_table = as.data.frame.matrix(table(vpheno$drug, vpheno$phenotype))

frs1.0_pred_table = fread(VPRED_FRS1) %>%
  with(table(.$drug, .$prediction))



validation_results = validation_results %>%
  mutate(catalogue = rep("new", nrow(validation_results)))


who_2_results = who_2_results %>%
  mutate(catalogue = rep("WHOv2", nrow(who_2_results)))


all_validation_results = rbind(validation_results, who_2_results)

write.csv(all_validation_results, "/github/cryptic-catalogue/data/validation/all_catalogue_validation_stats_202406.csv", quote = F, row.names = F)


write.csv(validation_results, "/github/cryptic-catalogue/data/validation/validation_stats_catomatic202406.csv", quote = F, row.names = F)

write.csv(who_1_results, "/github/cryptic-catalogue/data/validation/validation_stats_whov1.csv", quote = F, row.names = F)

write.csv(who_2_results, "/github/cryptic-catalogue/data/validation/validation_stats_whov2.csv", quote = F, row.names = F)

write.csv(pheno_table, "/github/cryptic-catalogue/data/validation/validation_phenotypes_table.csv")
```

